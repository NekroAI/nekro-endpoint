# Edgent â€” äº§å“è®¾è®¡æ–‡æ¡£

**æœ€åæ›´æ–°**: 2025-10-31  
**é¡¹ç›®å½’å±**: NekroAI  
**åŸŸåï¼ˆé»˜è®¤ï¼‰**: edgent.nekro.ai **æŠ€æœ¯åŸºç¡€**: NekroEdge æ¨¡æ¿ï¼ˆHono + React + D1 + Material-UIï¼‰

---

## 1. äº§å“å®šä½

Edgent æ˜¯ä¸€ä¸ª**å¼€æºçš„è¾¹ç¼˜ç«¯ç‚¹æ‰˜ç®¡å¹³å°**ï¼Œä¾›æ‰‹åŠ¨éªŒè¯çš„ç”¨æˆ·åœ¨è¾¹ç¼˜å¿«é€Ÿéƒ¨ç½²ä¸‰ç±»æœåŠ¡ï¼š

- **é™æ€ç«¯ç‚¹**ï¼šæ‰˜ç®¡æ–‡æœ¬/é…ç½®æ–‡ä»¶ï¼ˆå¦‚è§„åˆ™åˆ—è¡¨ã€é…ç½®ç‰‡æ®µï¼‰
- **ä»£ç†ç«¯ç‚¹**ï¼šè½¬å‘è¯·æ±‚åˆ°ç›®æ ‡åœ°å€ï¼ˆå¦‚åŠ é€Ÿ GitHub raw å†…å®¹ï¼‰
- **è„šæœ¬ç«¯ç‚¹**ï¼šè¿è¡Œè‡ªå®šä¹‰ JS è„šæœ¬ï¼ˆPhase 2ï¼Œéœ€æ²™ç®±ï¼‰

**æŠ€æœ¯æ ˆ**ï¼ˆåŸºäº NekroEdge æ¨¡æ¿ï¼‰ï¼š

- åç«¯ï¼šHono + D1 + Drizzle ORM
- å‰ç«¯ï¼šReact + Material-UI + Monaco Editor
- éƒ¨ç½²ï¼šCloudflare Workers + Pages

---

## 2. æ ¸å¿ƒçº¦æŸ

- **ç”¨æˆ·æ¿€æ´»åˆ¶**ï¼šç®¡ç†å‘˜æ‰‹åŠ¨æ¿€æ´»åæ‰èƒ½å‘å¸ƒç«¯ç‚¹
- **å¼€æºè‡ªæ‰˜ç®¡**ï¼šé¢å‘å°è§„æ¨¡ä½¿ç”¨ï¼Œæ— é…é¢/è®¡è´¹

---

## 3. æ ¸å¿ƒåŠŸèƒ½ï¼ˆäº§å“å±‚ï¼‰

### 3.1 è®¤è¯ä¸æ¿€æ´»

- GitHub OAuth ç™»å½•
- **æœªæ¿€æ´»ç”¨æˆ·**ï¼šå¯æŸ¥çœ‹ç•Œé¢ï¼Œä¸å¯å‘å¸ƒ
- **æ¿€æ´»ç”¨æˆ·**ï¼šå¯å‘å¸ƒç«¯ç‚¹
- **ç®¡ç†å‘˜**ï¼š
  - å¯æ¿€æ´»/åœç”¨ç”¨æˆ·
  - å¯æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„ç«¯ç‚¹æ ‘å’Œå…·ä½“å†…å®¹ï¼ˆç”¨äºå®‰å…¨å®¡æŸ¥ï¼‰
  - å¯å¼ºåˆ¶ä¸‹çº¿ä»»ä½•ç«¯ç‚¹

### 3.2 åŒå±‚å¯†é’¥æœºåˆ¶

**Platform API Keyï¼ˆç®¡ç†å‡­è¯ï¼‰**:

- ç”¨äºæ“ä½œå¹³å°åŠŸèƒ½ï¼ˆåˆ›å»º/ç¼–è¾‘ç«¯ç‚¹ã€ç®¡ç†æƒé™ç»„ï¼‰
- ä¸å¯¹å¤–åˆ†å‘

**Endpoint Access Keyï¼ˆæœåŠ¡å‡­è¯ï¼‰**:

- ç”¨äºè®¿é—®ç”¨æˆ·å‘å¸ƒçš„ç«¯ç‚¹
- é€šè¿‡æƒé™ç»„ç®¡ç†ï¼Œå¯å¯¹å¤–åˆ†å‘

### 3.3 ç«¯ç‚¹ç±»å‹

- **é™æ€ç«¯ç‚¹**ï¼šæ‰˜ç®¡æ–‡æœ¬å†…å®¹
- **ä»£ç†ç«¯ç‚¹**ï¼šè½¬å‘è¯·æ±‚åˆ°ç›®æ ‡ URL
- **è„šæœ¬ç«¯ç‚¹**ï¼šè¿è¡Œè‡ªå®šä¹‰ JSï¼ˆPhase 3ï¼‰

### 3.4 æ ‘å½¢ç«¯ç‚¹ç¼–è¾‘å™¨

**å¸ƒå±€**: å·¦ä¾§æ ‘è§†å›¾ + å³ä¾§ç¼–è¾‘å™¨ï¼ˆMonaco Editorï¼‰

**æ ‘ç»“æ„è¯´æ˜**:

- çº¯ç²¹çš„å±‚æ¬¡ç»“æ„ï¼Œç”±ç”¨æˆ·è‡ªç”±ç»„ç»‡
- **æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç«¯ç‚¹**ï¼Œæ— è®ºæ˜¯å¦æœ‰å­èŠ‚ç‚¹ï¼š
  - æœ‰å­èŠ‚ç‚¹çš„ç«¯ç‚¹ï¼ˆå®¹å™¨èŠ‚ç‚¹ï¼‰ï¼šæ—¢å¯ä»¥é…ç½®è‡ªå·±çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥åŒ…å«å­ç«¯ç‚¹
  - æ— å­èŠ‚ç‚¹çš„ç«¯ç‚¹ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰ï¼šä»…é…ç½®è‡ªå·±çš„å†…å®¹
- ç±»å‹ï¼ˆé™æ€/ä»£ç†/è„šæœ¬ï¼‰åªæ˜¯ç«¯ç‚¹çš„å±æ€§ï¼Œä¸æ ‘ç»“æ„æ— å…³
- **æ’åºè§„åˆ™**ï¼š
  - ä¼˜å…ˆæŒ‰ `sortOrder` å­—æ®µæ’åºï¼ˆç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´é¡ºåºåä½¿ç”¨ï¼‰
  - å…¶æ¬¡æŒ‰åç§°å­—æ¯é¡ºåºæ’åˆ—ï¼ˆä¸­æ–‡æ‹¼éŸ³é¡ºåºï¼‰
- ç¤ºä¾‹ï¼š
  ```
  æˆ‘çš„ç«¯ç‚¹/
    â”œâ”€ APIé›†åˆ [é™æ€]           â† å®¹å™¨èŠ‚ç‚¹ï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç«¯ç‚¹
    â”‚   â”œâ”€ GitHubä»£ç† [ä»£ç†]
    â”‚   â””â”€ é…ç½®æ–‡ä»¶ [é™æ€]
    â””â”€ æµ‹è¯•è„šæœ¬ [è„šæœ¬]
  ```

**åŠŸèƒ½**:

- å³é”®èœå•ï¼ˆæ–°å»ºå­ç«¯ç‚¹ã€åˆ é™¤ï¼‰
- ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹/ç¼–è¾‘é…ç½®
- å®æ—¶ä¿å­˜æç¤º
- å‘å¸ƒ/å–æ¶ˆå‘å¸ƒæ§åˆ¶

### 3.5 æƒé™ç»„ç³»ç»Ÿ

**æ•°æ®æ¨¡å‹**:

```
ç”¨æˆ· â†’ æƒé™ç»„ â†’ è®¿é—®å¯†é’¥
           â†“
         ç«¯ç‚¹
```

**æµç¨‹**:

1. åˆ›å»ºæƒé™ç»„ï¼ˆå¦‚ "VIPå®¢æˆ·"ï¼‰
2. ç”Ÿæˆè®¿é—®å¯†é’¥ï¼ˆæ ¼å¼ï¼š`ep-<éšæœºå­—ç¬¦ä¸²>`ï¼Œæ”¯æŒå¤‡æ³¨ã€åˆ°æœŸæ—¶é—´ï¼‰
3. ç«¯ç‚¹å…³è”æƒé™ç»„
4. å®¢æˆ·ç«¯æºå¸¦å¯†é’¥è®¿é—®ï¼š`Authorization: Bearer ep-xxx` æˆ– `?token=ep-xxx`

### 3.6 å…¶ä»–åŠŸèƒ½

- **è®¿é—®è·¯å¾„**: `/e/{username}/{path}`
- **ç¯å¢ƒå˜é‡**: åŠ å¯†å­˜å‚¨ï¼Œç”¨äºæ¨¡æ¿æ›¿æ¢
- **è®¿é—®æ§åˆ¶**: å…¬å¼€ / éœ€è¦é‰´æƒ

---

## 4. æ¶æ„æ¦‚è§ˆ

- **æ‰§è¡Œå±‚**: Cloudflare Workers å¤„ç† `/e/{username}/*` è¯·æ±‚
- **æ•°æ®å±‚**: D1 å­˜å‚¨ç”¨æˆ·/ç«¯ç‚¹é…ç½®
- **æ§åˆ¶é¢**: Hono API æä¾›ç®¡ç†æ¥å£
- **éš”ç¦»**: è„šæœ¬ç«¯ç‚¹æ²™ç®±åŒ–ï¼ˆPhase 3ï¼‰

---

## 5. æ•°æ®æ¨¡å‹è®¾è®¡ï¼ˆåŸºäº Drizzle ORMï¼‰

ä¸ºä¾¿äºä¸ D1 æ•°æ®åº“å’Œ Drizzle ORM å¯¹é½ï¼Œç»™å‡ºæ¯ä¸ªèµ„æºçš„**å­—æ®µæ¸…å•**ã€‚

### Userï¼ˆç”¨æˆ·è¡¨ï¼‰

```typescript
// å¯¹åº” Drizzle Schema
{
  id: text("id").primaryKey(),  // UUID
  username: text("username").notNull().unique(),  // GitHub ç”¨æˆ·å
  email: text("email"),
  avatar_url: text("avatar_url"),
  role: text("role", { enum: ["user", "admin"] }).notNull().default("user"),
  is_activated: integer("is_activated", { mode: "boolean" }).notNull().default(false),

  // Platform API Key (ç”¨æˆ·ç®¡ç†å¹³å°çš„å¯†é’¥)
  platform_api_key: text("platform_api_key"),  // å“ˆå¸Œå­˜å‚¨
  platform_api_key_created_at: integer("platform_api_key_created_at"),  // Unix æ—¶é—´æˆ³

  created_at: integer("created_at").notNull(),  // Unix æ—¶é—´æˆ³
  updated_at: integer("updated_at").notNull(),
  last_login_at: integer("last_login_at"),
}
```

**è¯´æ˜**:

- `platform_api_key`: ç”¨æˆ·ç®¡ç†å¹³å°çš„ API å¯†é’¥ï¼ˆå“ˆå¸Œåå­˜å‚¨ï¼‰
- ä½¿ç”¨ SQLite çš„ `integer` ç±»å‹å­˜å‚¨æ—¶é—´æˆ³ï¼ˆDrizzle æ¨¡å¼ï¼‰

### Endpointï¼ˆç«¯ç‚¹è¡¨ï¼‰

```typescript
{
  id: text("id").primaryKey(),  // UUID
  owner_user_id: text("owner_user_id").notNull().references(() => users.id),
  parent_id: text("parent_id"),  // ğŸ†• æ”¯æŒæ ‘å½¢ç»“æ„ï¼Œnull è¡¨ç¤ºæ ¹èŠ‚ç‚¹

  path: text("path").notNull(),  // ç›¸å¯¹è·¯å¾„ï¼Œå¦‚ /clash-config
  name: text("name").notNull(),  // æ˜¾ç¤ºå
  type: text("type", { enum: ["static", "proxy", "script"] }).notNull(),

  // ç«¯ç‚¹é…ç½®ï¼ˆJSON å­˜å‚¨ï¼Œæ ¹æ® type ä¸åŒç»“æ„ä¸åŒï¼‰
  config: text("config").notNull(),  // JSON string

  // è®¿é—®æ§åˆ¶
  access_control: text("access_control", { enum: ["public", "authenticated"] })
    .notNull().default("public"),
  required_permission_groups: text("required_permission_groups"),  // ğŸ†• JSON array of group_ids

  enabled: integer("enabled", { mode: "boolean" }).notNull().default(true),
  is_published: integer("is_published", { mode: "boolean" }).notNull().default(false),

  // æ’åºå­—æ®µï¼ˆæ”¯æŒæ ‘èŠ‚ç‚¹æ‰‹åŠ¨æ’åºï¼‰
  sort_order: integer("sort_order").notNull().default(0),  // ğŸ†•

  created_at: integer("created_at").notNull(),
  updated_at: integer("updated_at").notNull(),
}

// å¤åˆç´¢å¼•
index("endpoint_owner_path_idx").on(owner_user_id, path).unique()
index("endpoint_parent_idx").on(parent_id)
```

**config å­—æ®µç»“æ„ç¤ºä¾‹**:

```typescript
// é™æ€ç«¯ç‚¹
{
  content: string,
  response_headers: { [key: string]: string },
  cache_control?: string,
}

// ä»£ç†ç«¯ç‚¹
{
  target_url_template: string,  // å¦‚ "https://raw.githubusercontent.com/${path}"
  path_mapping?: { [pattern: string]: string },
  request_headers?: { [key: string]: string },
  response_headers?: { [key: string]: string },
}

// è„šæœ¬ç«¯ç‚¹ (Phase 2)
{
  script_content: string,
  timeout_ms: number,
  allowed_domains?: string[],
}
```

### PermissionGroupï¼ˆæƒé™ç»„è¡¨ï¼‰ğŸ†•

```typescript
{
  id: text("id").primaryKey(),  // UUID
  owner_user_id: text("owner_user_id").notNull().references(() => users.id),
  name: text("name").notNull(),  // å¦‚ "VIPç”¨æˆ·"ã€"å…è´¹è¯•ç”¨"
  description: text("description"),
  created_at: integer("created_at").notNull(),
  updated_at: integer("updated_at").notNull(),
}

index("perm_group_owner_idx").on(owner_user_id)
```

### AccessKeyï¼ˆè®¿é—®å¯†é’¥è¡¨ï¼‰

```typescript
{
  id: text("id").primaryKey(),  // UUID
  permission_group_id: text("permission_group_id").notNull()
    .references(() => permission_groups.id, { onDelete: "cascade" }),

  key_value: text("key_value").notNull().unique(),  // å¯†é’¥å“ˆå¸Œå€¼

  description: text("description"),  // å¤‡æ³¨
  expires_at: integer("expires_at"),  // è¿‡æœŸæ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰ï¼Œnull è¡¨ç¤ºæ°¸ä¹…
  is_active: integer("is_active", { mode: "boolean" }).notNull().default(true),

  last_used_at: integer("last_used_at"),  // æœ€åä½¿ç”¨æ—¶é—´
  usage_count: integer("usage_count").notNull().default(0),  // ä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡

  created_at: integer("created_at").notNull(),
}

index("access_key_group_idx").on(permission_group_id)
```

**å¯†é’¥æ ¼å¼**: `ep-<32ä½éšæœºå­—ç¬¦ä¸²>`ï¼ˆå¦‚ `ep-a7b3c9d2e1f4g5h6...`ï¼‰

### EnvVarï¼ˆç¯å¢ƒå˜é‡è¡¨ï¼‰

```typescript
{
  id: text("id").primaryKey(),  // UUID
  user_id: text("user_id").notNull().references(() => users.id),
  key: text("key").notNull(),
  value: text("value").notNull(),  // åŠ å¯†å­˜å‚¨
  created_at: integer("created_at").notNull(),
  updated_at: integer("updated_at").notNull(),
}

unique("env_var_user_key_idx").on(user_id, key)
```

### AccessLogï¼ˆè®¿é—®æ—¥å¿—è¡¨ï¼‰

```typescript
{
  id: text("id").primaryKey(),  // UUID
  endpoint_id: text("endpoint_id").notNull().references(() => endpoints.id),
  access_key_id: text("access_key_id"),  // ä½¿ç”¨çš„å¯†é’¥ IDï¼ˆå¦‚é€‚ç”¨ï¼‰

  timestamp: integer("timestamp").notNull(),
  status: integer("status").notNull(),  // HTTP çŠ¶æ€ç 
  method: text("method").notNull(),

  ip_address: text("ip_address"),
  country: text("country"),  // Cloudflare æä¾›çš„åœ°ç†ä¿¡æ¯
  user_agent: text("user_agent"),

  response_time_ms: integer("response_time_ms"),
}

index("access_log_endpoint_idx").on(endpoint_id)
index("access_log_timestamp_idx").on(timestamp)
```

### OAuth Sessionï¼ˆOAuth ä¼šè¯è¡¨ï¼‰

```typescript
{
  id: text("id").primaryKey(),
  user_id: text("user_id").notNull().references(() => users.id),
  provider: text("provider").notNull().default("github"),

  access_token: text("access_token").notNull(),  // åŠ å¯†å­˜å‚¨
  refresh_token: text("refresh_token"),
  expires_at: integer("expires_at"),

  created_at: integer("created_at").notNull(),
  updated_at: integer("updated_at").notNull(),
}

index("oauth_session_user_idx").on(user_id)
```

---

## 6. API è®¾è®¡è§„èŒƒï¼ˆRESTful + OpenAPIï¼‰

æ‰€æœ‰ API å‡ä½¿ç”¨ Hono + @hono/zod-openapi å®ç°ï¼Œç¡®ä¿ç±»å‹å®‰å…¨å’Œè‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆã€‚

### 6.1 è®¤è¯ä¸ç”¨æˆ·ç®¡ç†

#### OAuth è®¤è¯

- `GET /api/auth/github` â€” å‘èµ· GitHub OAuth ç™»å½•
- `GET /api/auth/callback` â€” GitHub OAuth å›è°ƒå¤„ç†
- `POST /api/auth/logout` â€” ç™»å‡ºå½“å‰ç”¨æˆ·
- `GET /api/auth/me` â€” è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

#### å¹³å° API å¯†é’¥ç®¡ç†

- `POST /api/user/api-key/generate` â€” ç”Ÿæˆæ–°çš„å¹³å°ç®¡ç†å¯†é’¥ï¼ˆæ›¿æ¢æ—§å¯†é’¥ï¼‰
- `DELETE /api/user/api-key` â€” æ’¤é”€å½“å‰å¹³å°ç®¡ç†å¯†é’¥
- `GET /api/user/api-key/info` â€” æŸ¥çœ‹å¯†é’¥åˆ›å»ºæ—¶é—´ï¼ˆä¸è¿”å›å¯†é’¥æœ¬èº«ï¼‰

### 6.2 ç«¯ç‚¹ç®¡ç†ï¼ˆEndpointsï¼‰

#### åŸºç¡€ CRUD

- `GET /api/endpoints` â€” åˆ—å‡ºå½“å‰ç”¨æˆ·æ‰€æœ‰ç«¯ç‚¹ï¼ˆæ ‘å½¢ç»“æ„ï¼‰
  - æŸ¥è¯¢å‚æ•°: `?flat=true` è¿”å›æ‰å¹³åˆ—è¡¨ï¼Œé»˜è®¤è¿”å›æ ‘ç»“æ„
- `POST /api/endpoints` â€” åˆ›å»ºæ–°ç«¯ç‚¹
  - è¯·æ±‚ä½“: `{ name, type, path, parent_id?, config }`
- `GET /api/endpoints/:id` â€” è·å–ç«¯ç‚¹è¯¦æƒ…
- `PATCH /api/endpoints/:id` â€” æ›´æ–°ç«¯ç‚¹é…ç½®
- `DELETE /api/endpoints/:id` â€” åˆ é™¤ç«¯ç‚¹ï¼ˆçº§è”åˆ é™¤å­èŠ‚ç‚¹ï¼‰

#### å‘å¸ƒä¸çŠ¶æ€ç®¡ç†

- `POST /api/endpoints/:id/publish` â€” å‘å¸ƒç«¯ç‚¹ï¼ˆéœ€å·²æ¿€æ´»ç”¨æˆ·ï¼‰
- `POST /api/endpoints/:id/unpublish` â€” å–æ¶ˆå‘å¸ƒ
- `PATCH /api/endpoints/:id/toggle` â€” å¿«é€Ÿå¯ç”¨/ç¦ç”¨ç«¯ç‚¹

#### æ ‘ç»“æ„æ“ä½œ ğŸ†•

- `PATCH /api/endpoints/:id/move` â€” ç§»åŠ¨ç«¯ç‚¹åˆ°æ–°çˆ¶èŠ‚ç‚¹
  - è¯·æ±‚ä½“: `{ parent_id: string | null, sort_order?: number }`
- `POST /api/endpoints/reorder` â€” æ‰¹é‡è°ƒæ•´ç«¯ç‚¹æ’åº
  - è¯·æ±‚ä½“: `{ endpoint_orders: [{ id, sort_order }] }`

### 6.3 æƒé™ç»„ç®¡ç†ï¼ˆPermission Groupsï¼‰ğŸ†•

- `GET /api/permission-groups` â€” åˆ—å‡ºå½“å‰ç”¨æˆ·çš„æ‰€æœ‰æƒé™ç»„
- `POST /api/permission-groups` â€” åˆ›å»ºæ–°æƒé™ç»„
  - è¯·æ±‚ä½“: `{ name, description? }`
- `GET /api/permission-groups/:id` â€” è·å–æƒé™ç»„è¯¦æƒ…ï¼ˆå«å…³è”ç«¯ç‚¹å’Œå¯†é’¥åˆ—è¡¨ï¼‰
- `PATCH /api/permission-groups/:id` â€” æ›´æ–°æƒé™ç»„ä¿¡æ¯
- `DELETE /api/permission-groups/:id` â€” åˆ é™¤æƒé™ç»„ï¼ˆçº§è”åˆ é™¤æ‰€æœ‰å¯†é’¥ï¼‰

### 6.4 è®¿é—®å¯†é’¥ç®¡ç†ï¼ˆAccess Keysï¼‰ğŸ†•

- `GET /api/permission-groups/:groupId/keys` â€” åˆ—å‡ºæƒé™ç»„çš„æ‰€æœ‰å¯†é’¥
- `POST /api/permission-groups/:groupId/keys` â€” ç”Ÿæˆæ–°å¯†é’¥
  - è¯·æ±‚ä½“: `{ description?, expires_at?: timestamp }`
  - å“åº”: **ä»…åœ¨åˆ›å»ºæ—¶è¿”å›å®Œæ•´å¯†é’¥æ˜æ–‡**ï¼Œä¹‹åæ— æ³•å†æ¬¡è·å–
- `PATCH /api/access-keys/:id` â€” æ›´æ–°å¯†é’¥ï¼ˆä¿®æ”¹å¤‡æ³¨ã€åˆ°æœŸæ—¶é—´ï¼‰
- `POST /api/access-keys/:id/revoke` â€” æ’¤é”€å¯†é’¥ï¼ˆè®¾ç½® is_active=falseï¼‰
- `DELETE /api/access-keys/:id` â€” æ°¸ä¹…åˆ é™¤å¯†é’¥

### 6.5 ç¯å¢ƒå˜é‡ç®¡ç†

- `GET /api/env-vars` â€” åˆ—å‡ºå½“å‰ç”¨æˆ·çš„ç¯å¢ƒå˜é‡ï¼ˆä¸è¿”å› valueï¼‰
- `POST /api/env-vars` â€” åˆ›å»ºæ–°ç¯å¢ƒå˜é‡
  - è¯·æ±‚ä½“: `{ key, value }`
- `PUT /api/env-vars/:key` â€” æ›´æ–°ç¯å¢ƒå˜é‡å€¼
- `DELETE /api/env-vars/:key` â€” åˆ é™¤ç¯å¢ƒå˜é‡

### 6.6 ç®¡ç†å‘˜æ¥å£ï¼ˆAdmin Onlyï¼‰

#### ç”¨æˆ·ç®¡ç†

- `GET /api/admin/users` â€” åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·ï¼ˆåˆ†é¡µï¼‰
- `POST /api/admin/users/:id/activate` â€” æ¿€æ´»ç”¨æˆ·
- `POST /api/admin/users/:id/deactivate` â€” åœç”¨ç”¨æˆ·
- `DELETE /api/admin/users/:id` â€” åˆ é™¤ç”¨æˆ·

#### ç«¯ç‚¹å®¡æŸ¥ï¼ˆå®‰å…¨å®¡è®¡ï¼‰

- `GET /api/admin/users/:userId/endpoints` â€” æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„å®Œæ•´ç«¯ç‚¹æ ‘
- `GET /api/admin/endpoints/:id` â€” æŸ¥çœ‹ä»»æ„ç«¯ç‚¹çš„è¯¦ç»†å†…å®¹å’Œé…ç½®
- `POST /api/admin/endpoints/:id/force-unpublish` â€” å¼ºåˆ¶ä¸‹çº¿ç«¯ç‚¹

#### ç³»ç»Ÿç»Ÿè®¡

- `GET /api/admin/stats` â€” ç³»ç»Ÿç»Ÿè®¡ï¼ˆç”¨æˆ·æ•°ã€ç«¯ç‚¹æ•°ã€è¯·æ±‚é‡ç­‰ï¼‰

### 6.7 å…¬å¼€ç«¯ç‚¹è®¿é—®ï¼ˆExecution Layerï¼‰

- `GET|POST|PUT|DELETE /e/:username/:path/*` â€” è®¿é—®ç”¨æˆ·å‘å¸ƒçš„ç«¯ç‚¹
  - é‰´æƒæ–¹å¼:
    - HTTP Header: `Authorization: Bearer <access_key>`
    - æˆ– Query å‚æ•°: `?token=<access_key>`
  - å“åº”æ ¹æ®ç«¯ç‚¹ç±»å‹å’Œé…ç½®åŠ¨æ€ç”Ÿæˆ

### é”™è¯¯ç è§„èŒƒ

```typescript
// æ ‡å‡†é”™è¯¯å“åº”æ ¼å¼
{
  code: number,       // HTTP çŠ¶æ€ç 
  error: string,      // é”™è¯¯ç±»å‹ï¼ˆå¦‚ "unauthorized", "not_found"ï¼‰
  message: string,    // ç”¨æˆ·å‹å¥½çš„é”™è¯¯æè¿°
  details?: any,      // é¢å¤–çš„é”™è¯¯ç»†èŠ‚ï¼ˆå¯é€‰ï¼‰
}

// å¸¸è§é”™è¯¯ç æ˜ å°„
200 OK               â€” æˆåŠŸ
201 Created          â€” åˆ›å»ºæˆåŠŸ
400 Bad Request      â€” è¯·æ±‚å‚æ•°é”™è¯¯
401 Unauthorized     â€” æœªè®¤è¯æˆ–è®¤è¯å¤±è´¥
403 Forbidden        â€” æ— æƒé™æ‰§è¡Œæ“ä½œ
404 Not Found        â€” èµ„æºä¸å­˜åœ¨
409 Conflict         â€” èµ„æºå†²çªï¼ˆå¦‚é‡å¤åˆ›å»ºï¼‰
422 Unprocessable    â€” æ•°æ®éªŒè¯å¤±è´¥ï¼ˆZod é”™è¯¯ï¼‰
429 Too Many Requests â€” é€Ÿç‡é™åˆ¶
500 Internal Error   â€” æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
```

---

## 7. å®‰å…¨å®ç°è¦ç‚¹

### 7.1 è®¤è¯

- GitHub OAuth + HttpOnly Cookie ä¼šè¯ç®¡ç†
- å¯†é’¥å“ˆå¸Œå­˜å‚¨ï¼ˆä½¿ç”¨ Web Crypto API çš„ PBKDF2ï¼Œé¿å… bcrypt æ€§èƒ½é—®é¢˜ï¼‰

### 7.2 æƒé™æ§åˆ¶

```typescript
// è®¤è¯ä¸­é—´ä»¶
app.use("/api/*", authMiddleware);
// æ¿€æ´»æ£€æŸ¥
app.use("/api/endpoints/*/publish", activationMiddleware);
// ç®¡ç†å‘˜æƒé™
app.use("/api/admin/*", adminMiddleware);
```

### 7.3 æ•°æ®åŠ å¯†

- ç¯å¢ƒå˜é‡ï¼šAES-GCM åŠ å¯†å­˜å‚¨
- OAuth Tokenï¼šåŠ å¯†å­˜å‚¨

---

## 8. æŠ€æœ¯å®ç°è¦ç‚¹

### 8.1 å‰ç«¯æ¶æ„

**é¡µé¢ç»“æ„**:

- `pages/auth/` - OAuth ç™»å½•å›è°ƒ
- `pages/dashboard/` - ç«¯ç‚¹ç®¡ç†ã€æƒé™ç»„
- `pages/admin/` - ç”¨æˆ·ç®¡ç†
- `components/endpoints/` - æ ‘å½¢ç¼–è¾‘å™¨ã€Monaco Editor
- `components/permissions/` - æƒé™ç»„å¡ç‰‡ã€å¯†é’¥åˆ—è¡¨

**çŠ¶æ€ç®¡ç†**: React Queryï¼ˆå·²é›†æˆï¼‰

**æ–°å¢ä¾èµ–**:

```bash
pnpm add @mui/x-tree-view @monaco-editor/react @dnd-kit/core @dnd-kit/sortable uuid
```

### 8.2 åç«¯æ¶æ„

**è·¯ç”±ç»„ç»‡**:

```
src/routes/
  â”œâ”€â”€ auth.ts         # OAuth
  â”œâ”€â”€ endpoints.ts    # ç«¯ç‚¹ CRUD
  â”œâ”€â”€ permission-groups.ts
  â”œâ”€â”€ execution.ts    # /e/* æ‰§è¡Œå±‚
  â””â”€â”€ admin.ts
```

**Bindings æ‰©å±•**ï¼ˆ`src/types.ts`ï¼‰:

```typescript
GITHUB_CLIENT_ID: string;
GITHUB_CLIENT_SECRET: string;
SESSION_SECRET: string;
ENCRYPTION_KEY: string;
```

---

## 9. å…³é”®æŠ€æœ¯é—®é¢˜

### 9.1 Monaco Editor SSR é—®é¢˜

ä½¿ç”¨åŠ¨æ€å¯¼å…¥ç¦ç”¨ SSR æˆ–åœ¨ vite.config ä¸­æ’é™¤

### 9.2 æ ‘å½¢ç»“æ„å¾ªç¯å¼•ç”¨

æ›´æ–° parent_id æ—¶é€’å½’æ£€æŸ¥é˜²æ­¢å¾ªç¯

### 9.3 å¯†é’¥å“ˆå¸Œæ€§èƒ½

ä½¿ç”¨ PBKDF2ï¼ˆWeb Crypto APIï¼‰æ›¿ä»£ bcrypt

---

## 10. å¼€å‘ä»»åŠ¡æ¸…å•

### Phase 1 â€” MVPï¼ˆåŸºç¡€åŠŸèƒ½ï¼‰

#### åç«¯

- [ ] æ•°æ®åº“ Schemaï¼ˆusers, endpoints, oauth_sessionsï¼‰
- [ ] GitHub OAuth è®¤è¯æµç¨‹
- [ ] ç«¯ç‚¹ CRUD APIï¼ˆé™æ€ã€ä»£ç†ï¼‰
- [ ] ç«¯ç‚¹æ‰§è¡Œå±‚ï¼ˆ`/e/:username/:path`ï¼‰
- [ ] ç®¡ç†å‘˜æ¿€æ´»ç”¨æˆ· API

#### å‰ç«¯

- [ ] OAuth ç™»å½•/å›è°ƒé¡µé¢
- [ ] æ ‘å½¢ç«¯ç‚¹ç¼–è¾‘å™¨ï¼ˆTreeView + Monaco Editorï¼‰
- [ ] é™æ€ç«¯ç‚¹ç¼–è¾‘å™¨
- [ ] ä»£ç†ç«¯ç‚¹é…ç½®è¡¨å•
- [ ] ç”¨æˆ·è®¾ç½®é¡µé¢
- [ ] ç®¡ç†å‘˜ç”¨æˆ·åˆ—è¡¨

### Phase 2 â€” æƒé™ç»„ç³»ç»Ÿ

#### åç«¯

- [ ] æƒé™ç»„/è®¿é—®å¯†é’¥è¡¨ç»“æ„
- [ ] å¹³å° API Key ç®¡ç†
- [ ] æƒé™ç»„ CRUD API
- [ ] è®¿é—®å¯†é’¥ç”Ÿæˆ/æ’¤é”€ API
- [ ] ç«¯ç‚¹é‰´æƒé€»è¾‘

#### å‰ç«¯

- [ ] æƒé™ç»„ç®¡ç†ç•Œé¢
- [ ] è®¿é—®å¯†é’¥åˆ—è¡¨
- [ ] ç«¯ç‚¹æƒé™ç»„é€‰æ‹©å™¨

### Phase 3 â€” è„šæœ¬ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰

- [ ] æ²™ç®±éš”ç¦»å®ç°
- [ ] è„šæœ¬ç«¯ç‚¹æ‰§è¡Œå¼•æ“
- [ ] Monaco Editor TypeScript æ”¯æŒ

---

**æœ€åæ›´æ–°**: 2025-10-31
